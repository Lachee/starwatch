<html>
<head>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />

        <script
            src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
            crossorigin="anonymous"></script>
			
<script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
<script src="js/sbname.js"></script>
<style>
	#map {
		width: 100%;
		height: 100%;
		background: #120115bf;
	}
	
	body{
		padding: 0;
		margin: 0;
		background: url('map/space.jpg');
	}
	
	.control {
		position: absolute;
		top: 12px;
		left: 60px;
	}

	.control input {
		border-radius: 3px;
		border: 1px solid black;
		padding: 4px;
	}

	.leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #353535; color: #dedede }

</style>
</head>

<body>
	<div id="map"></div>
	<div class="control">
		<input id="x" type="text" value="17" />
		<input id="y" type="text" value="17" />
		<button onclick="flyToInput();">Fly</button>
	</div>
</body>

<script>
	var scale = 0.5;
	var worldOffset = 1;
	function s(v) {  return v < 0 ? -Math.log10(Math.abs(v)) : Math.log10(v); }
	//function s(v) {  return v; }

//https://leafletjs.com/examples/crs-simple/crs-simple.html
//https://github.com/Leaflet/Leaflet.markercluster#options
	var yx = L.latLng;
	var xy = function(x, y) 
	{
		let x2 = x;
		let y2 = y;
		if (L.Util.isArray(x)) 
		{
			// We are doing xy([x, y]);    
			x2 = x[0];
			y2 = x[1];
		}
		
		//Apply scales
		x2 = s(x2) * scale;
		y2 = s(y2) * scale;
		
		//Return the response
		return yx(y2, x2);  // When doing xy(x, y);
	};

	var rcircle = function(x, y, r)
	{
		var angle = Math.random()*Math.PI*2
		return [ x + (Math.cos(angle) * r), y + (Math.sin(angle) * r)]
	}

	var StarIcon = L.Icon.extend({
		options: {
			shadowUrl: '',
			iconSize:     [26, 26],
			shadowSize:   [13, 13],
			iconAnchor:   [5, 5],
			shadowAnchor: [5, 5],
			popupAnchor:  [9, 0]
		}
	});
	var blueStarIcon = new StarIcon({iconUrl: 'map/star13pxLightBlue-scaled.gif'});

	var map = L.map('map', {
		crs: L.CRS.Simple,
		minZoom: -3
	});

	var bounds = [[-26.5,-25], [1021.5,1023]];
	map.setView([-0.35, 0.42], 10);
	//var image = L.imageOverlay('uqm_map_full.png', bounds).addTo(map);

	
	function getPopup(world)
	{
		return "<b>" + formatStarboundTags(world.Details.Name) + "</b><hr>" + world.Details.Description + "<br>" + world.Details.TerrainType + " (" + world.Details.TerrainSize + ")<br>" + world.Details.PrimaryBiome + "<br>" + world.Whereami;
	}


	getWorlds(map, scale);
	function getWorlds(map, scale = 1)
	{
		const Http = new XMLHttpRequest();
		const url='https://sb.ilovebacons.com:4242/api/world/search?systems';
		Http.open("GET", url);
		Http.send();

		Http.onreadystatechange = (e) => {
			if (Http.readyState == 4 && Http.status == 200)
			{
				var response = JSON.parse(Http.responseText);
				console.log(response.Response);
				for(var key in response.Response)
				{
					var world = null;
					for(var i in response.Response[key]) 
					{
						world = response.Response[key][i];
						var pos = rcircle(world.X, world.Y, worldOffset);
						var coord = xy(pos[0], pos[1]);
						L.marker(coord, {icon: blueStarIcon}).addTo(map).bindPopup(getPopup(world));
						console.log(coord, key);
					}
						
					//if (world != null)
					//	L.marker(xy(world.X, world.Y)).addTo(map).bindPopup("System: " + world.X + ", " + world.Y);
				}
				
				
				map.flyTo([-0.35, 0.42], 6);
			}
		}
	}
	
	function locatePlayer(map, connection)
	{
		const Http = new XMLHttpRequest();
		const url='https://sb.ilovebacons.com:4242/api/player/' + connection + '?enforce=true';
		Http.open("GET", url);
		Http.send();

		Http.onreadystatechange = (e) => {
			if (Http.readyState == 4 && Http.status == 200)
			{
				var response = JSON.parse(Http.responseText);
				console.log(response.Response);
				flyToCelestial(map, response.Response.Location);
			}
		}
	}
	
	function flyToCelestial(map, celestial)
	{
		const Http = new XMLHttpRequest();
		const url='https://sb.ilovebacons.com:4242/api/world/' + celestial;
		Http.open("GET", url);
		Http.send();

		Http.onreadystatechange = (e) => {
			if (Http.readyState == 4 && Http.status == 200)
			{
				var response = JSON.parse(Http.responseText);				
				var world = response.Response;
				var coord = xy(world.X, world.Y);
				map.flyTo(coord, 4);
			}
		}
	}

	function flyToCoordinate(map, x, y) { 
		var coord = xy(x, y);
		map.flyTo(coord, 14);
	}

	function flyToInput()
	{
		let x = $('input#x').val();
		let y = $('input#y').val();
		flyToCoordinate(map, x, y);
	}

</script>

</html>
